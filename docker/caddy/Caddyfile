##########
# snippets
##########

(auth_proxy) {
  reverse_proxy oauth2-proxy:8000 {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-Uri {uri}
    header_up Host {host}
  }
}

(idp_proxy) {
  reverse_proxy keycloak:8080 {
    header_up Host {host}
  }
}

(auth_proxy_common) {
  uri /oauth2/auth
  header_up X-Real-IP {remote_host}
  copy_headers {
    X-FFun-User-Id
    X-FFun-Identity-Provider-Id
    Set-Cookie
  }
}

#######
# sites
#######

keycloak.local {
  tls internal

  # Remove all X-* headers to prevent header injection attacks
  request_header -X-*

  # TODO: reduce to only needed paths

  handle /oauth2/* {
    import auth_proxy
  }

  handle /auth/logout {
    # Tell oauth2-proxy to redirect to Keycloak logout endpoint after signing out and then back to us
    rewrite * /oauth2/sign_out?rd=https%3A%2F%2Fidp.keycloak.local%2Frealms%2Fdev%2Fprotocol%2Fopenid-connect%2Flogout%3Fclient_id%3Dauth-proxy-client%26post_logout_redirect_uri%3Dhttps%253A%252F%252Fkeycloak.local%252F%253Flogged-out

    import auth_proxy
  }

  handle /auth/login {
    rewrite * /oauth2/start?rd={query.return_to}
    import auth_proxy
  }

  handle /auth/join {
    rewrite * /oauth2/start?prompt=create&rd={query.return_to}
    import auth_proxy
  }

  handle /auth/* {
    route {
      forward_auth auth-proxy:8000 {
        import auth_proxy_common

        @unauth status 401
        handle_response @unauth {
          redir * /oauth2/sign_in?rd={scheme}://{host}{uri}
        }
      }

      @authCookie header Set-Cookie *
      header @authCookie +Set-Cookie {header.Set-Cookie}

      # TODO: maybe return simplified backend response?
      respond "Auth API response"
    }
  }

  handle /private/* {
    route {
      forward_auth auth-proxy:8000 {
        import auth_proxy_common
      }

      @authCookie header Set-Cookie *
      header @authCookie +Set-Cookie {header.Set-Cookie}

      respond "Private API response"
    }
  }

  handle /public/* {
    respond "Public API response"
  }

  handle / {
    # Simple HTML page with links to login, logout, private, and public

    header Content-Type text/html

    respond "
        <html>
            <body>
            <h1>Urls to test Keycloak</h1>
            <ul>
                <li><a href='https://idp.keycloak.local/'>Admin</a></li>
                <li><a href='/auth/login?return_to=/'>Login</a></li>
                <li><a href='/auth/join?return_to=/'>Join</a></li>
                <li><a href='/auth/logout'>Logout</a></li>
                <li><a href='/private/data'>Private Data</a></li>
                <li><a href='/public/data'>Public Data</a></li>
            </ul>
            </body>
        </html>
    "
  }
}

idp.keycloak.local {
  tls internal

  # Simple and effective way to disable Keycloak account console
  handle_path /realms/dev/account* {
    respond "Not found" 404
  }

  import idp_proxy
}
